<!DOCTYPE html>
<html lang="en"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6IjY0ZjA3ZDcxOTc5ZjQzODI3MjJhOGRmMzQwNzUzY2UwZmVkOThjYTgiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIxMjc1ODM2MTU4NDMzNTIyMzc4MCIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJlNDE4OTAxZjE4MjEtaW5kZXguaHRtbC00MjkifSwiZXhwIjoxNzcxNTY2ODMyLCJpYXQiOjE3NzE1NjMyMzIsImFsZyI6IlJTMjU2In0.LGE1-i3pFOJNBX9fxiNbioiYXc2P7fKZ5Y_hamY4F3ETRkcayx-0knVPewq_px0Es6vxdPPgTCwAY8NMGX0SRuWclFrwFCpiaCbQ5FZrurMVh5LbmuLdL-RYG8C5qoT8GOF2cQPpdYXN5XEnV7HeWAg-HmyMoSxuKwOdLW8XFNOdtEPjc9U_otQ_z1aZlgBpe4hbYk7THnW36srkJn5pcyzd_-nuEjQiO_a60BRZv91a50KXWCgzJg2BIJTpdjHRtAO0yvybf7FfGPfc1SKtfe9U8lv8r2gpoLxp3jPyjTRzEQ9w_uSrwT5eIIC5znGLwA1J8B3b7TEsZbspNkS5hA","e418901f1821-index.html-429")</script><script>(function(){'use strict';var h=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var n=l(this);
function p(a,b){if(b)a:{var d=n;a=a.split(".");for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in d))break a;d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&b!=null&&h(d,a,{configurable:!0,writable:!0,value:b})}}function r(a){function b(c){return a.next(c)}function d(c){return a.throw(c)}return new Promise(function(c,e){function f(g){g.done?c(g.value):Promise.resolve(g.value).then(b,d).then(f,e)}f(a.next())})}function t(a){return r(a())}
p("Object.values",function(a){return a?a:function(b){var d=[],c;for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&d.push(b[c]);return d}});p("Array.prototype.includes",function(a){return a?a:function(b,d){var c=this;c instanceof String&&(c=String(c));var e=c.length;d=d||0;for(d<0&&(d=Math.max(d+e,0));d<e;d++){var f=c[d];if(f===b||Object.is(f,b))return!0}return!1}});/*

 MIT License

 Copyright (c) 2017-2023 W.Y.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.

*/
function u(a,b){const d=a.style;b.backgroundColor&&(d.backgroundColor=b.backgroundColor);b.width&&(d.width=`${b.width}px`);b.height&&(d.height=`${b.height}px`);const c=b.style;c!=null&&Object.keys(c).forEach(e=>{d[e]=c[e]})};var v=(()=>{let a=0;return()=>{a+=1;return`u${`0000${(Math.random()*1679616<<0).toString(36)}`.slice(-4)}${a}`}})();function w(a){const b=[];for(let d=0,c=a.length;d<c;d++)b.push(a[d]);return b}let x=null;function y(a={}){return x?x:a.l?x=a.l:x=w(window.getComputedStyle(document.documentElement))}function z(a,b){return(a=(a.ownerDocument.defaultView||window).getComputedStyle(a).getPropertyValue(b))?parseFloat(a.replace("px","")):0}
function A(a,b={}){var d;if(!(d=b.width)){d=z(a,"border-left-width");var c=z(a,"border-right-width");d=a.clientWidth+d+c}(b=b.height)||(b=z(a,"border-top-width"),c=z(a,"border-bottom-width"),b=a.clientHeight+b+c);return{width:d,height:b}}function B(a){return new Promise((b,d)=>{const c=new Image;c.onload=()=>{c.decode().then(()=>{requestAnimationFrame(()=>b(c))})};c.onerror=d;c.crossOrigin="anonymous";c.decoding="async";c.src=a})}
function C(a){return t(function*(){return Promise.resolve().then(()=>(new XMLSerializer).serializeToString(a)).then(encodeURIComponent).then(b=>`data:image/svg+xml;charset=utf-8,${b}`)})}
function D(a,b,d){return t(function*(){const c=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");c.setAttribute("width",`${b}`);c.setAttribute("height",`${d}`);c.setAttribute("viewBox",`0 0 ${b} ${d}`);e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("x","0");e.setAttribute("y","0");e.setAttribute("externalResourcesRequired","true");c.appendChild(e);e.appendChild(a);return C(c)})}
var E=(a,b)=>{if(a instanceof b)return!0;a=Object.getPrototypeOf(a);return a===null?!1:a.constructor.name===b.name||E(a,b)};function F(a,b){return y(b).map(d=>{const c=a.getPropertyValue(d),e=a.getPropertyPriority(d);return`${d}: ${c}${e?" !important":""};`}).join(" ")}
function G(a,b,d,c){a=window.getComputedStyle(a,d);var e=a.getPropertyValue("content");if(e!==""&&e!=="none"){var f=v();try{b.className=`${b.className} ${f}`}catch(k){return}e=document.createElement("style");var g=e.appendChild;d=`.${f}:${d}`;a.cssText?(c=a.getPropertyValue("content"),c=`${a.cssText} content: '${c.replace(/'|"/g,"")}';`):c=F(a,c);g.call(e,document.createTextNode(`${d}{${c}}`));b.appendChild(e)}};function H(a){return a.search(/^(data:)/)!==-1}function I(a,b,d){return t(function*(){const c=yield fetch(a,b);if(c.status===404)throw Error(`Resource "${c.url}" not found`);const e=yield c.blob();return new Promise((f,g)=>{const k=new FileReader;k.onerror=g;k.onloadend=()=>{try{f(d({o:c,result:k.result}))}catch(m){g(m)}};k.readAsDataURL(e)})})}const J={};function K(a,b,d){let c=a.replace(/\?.*/,"");d&&(c=a);/ttf|otf|eot|woff2?/i.test(c)&&(c=c.replace(/.*\//,""));return b?`[${b}]${c}`:c}
function L(a,b,d){return t(function*(){const c=K(a,b,d.C);if(J[c]!=null)return J[c];d.u&&(a+=(/\?/.test(a)?"&":"?")+(new Date).getTime());let e;try{const f=yield I(a,d.i,({o:g,result:k})=>{b||(b=g.headers.get("Content-Type")||"");return k.split(/,/)[1]});e=`data:${b};base64,${f}`}catch(f){e=d.B||""}return J[c]=e})};const M={P:"application/font-woff",R:"application/font-woff",N:"application/font-truetype",v:"application/vnd.ms-fontobject",H:"image/png",F:"image/jpeg",D:"image/jpeg",A:"image/gif",M:"image/tiff",L:"image/svg+xml",O:"image/webp"};function N(a){return(a=/\.([^./]*?)$/g.exec(a))?a[1]:""};function O(a){return t(function*(){const b=a.toDataURL();return b==="data:,"?a.cloneNode(!1):B(b)})}function aa(a,b){return t(function*(){if(a.currentSrc){var d=document.createElement("canvas");const c=d.getContext("2d");d.width=a.clientWidth;d.height=a.clientHeight;c==null||c.drawImage(a,0,0,d.width,d.height);d=d.toDataURL();return B(d)}d=a.poster;d=yield L(d,M[N(d).toLowerCase()]||"",b);return B(d)})}
function ba(a,b){return t(function*(){try{let d;if(a==null?0:(d=a.contentDocument)==null?0:d.body)return yield P(a.contentDocument.body,b,!0)}catch(d){}return a.cloneNode(!1)})}function ca(a,b){return t(function*(){return E(a,HTMLCanvasElement)?O(a):E(a,HTMLVideoElement)?aa(a,b):E(a,HTMLIFrameElement)?ba(a,b):a.cloneNode(a.tagName!=null&&a.tagName.toUpperCase()==="SVG")})}
function da(a,b,d){return t(function*(){if(b.tagName!=null&&b.tagName.toUpperCase()==="SVG")return b;let c=[];if(a.tagName!=null&&a.tagName.toUpperCase()==="SLOT"&&a.assignedNodes)c=w(a.assignedNodes());else{let e;if(E(a,HTMLIFrameElement)&&((e=a.contentDocument)==null?0:e.body))c=w(a.contentDocument.body.childNodes);else{let f;c=w(((f=a.shadowRoot)!=null?f:a).childNodes)}}if(c.length===0||E(a,HTMLVideoElement))return b;yield c.reduce((e,f)=>e.then(()=>P(f,d)).then(g=>{g&&b.appendChild(g)}),Promise.resolve());
return b})}function ea(a,b,d){const c=b.style;if(c){var e=window.getComputedStyle(a);e.cssText?(c.cssText=e.cssText,c.transformOrigin=e.transformOrigin):y(d).forEach(f=>{let g=e.getPropertyValue(f);f==="font-size"&&g.endsWith("px")&&(g=`${Math.floor(parseFloat(g.substring(0,g.length-2)))-.1}px`);E(a,HTMLIFrameElement)&&f==="display"&&g==="inline"&&(g="block");f==="d"&&b.getAttribute("d")&&(g=`path(${b.getAttribute("d")})`);c.setProperty(f,g,e.getPropertyPriority(f))})}}
function fa(a,b){E(a,HTMLSelectElement)&&(b=Array.from(b.children).find(d=>a.value===d.getAttribute("value")))&&b.setAttribute("selected","")}
function ha(a,b){return t(function*(){var d=a.querySelectorAll?a.querySelectorAll("use"):[];if(d.length===0)return a;var c={};for(var e=0;e<d.length;e++){var f=d[e].getAttribute("xlink:href");if(f){const g=document.querySelector(f);a.querySelector(f)||!g||c[f]||(c[f]=yield P(g,b,!0))}}d=Object.values(c);if(d.length){c=document.createElementNS("http://www.w3.org/1999/xhtml","svg");c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");c.style.position="absolute";c.style.width="0";c.style.height="0";
c.style.overflow="hidden";c.style.display="none";e=document.createElementNS("http://www.w3.org/1999/xhtml","defs");c.appendChild(e);for(f=0;f<d.length;f++)e.appendChild(d[f]);a.appendChild(c)}return a})}
function P(a,b,d){return t(function*(){return d||!b.filter||b.filter(a)?Promise.resolve(a).then(c=>ca(c,b)).then(c=>da(a,c,b)).then(c=>{E(c,Element)&&(ea(a,c,b),G(a,c,":before",b),G(a,c,":after",b),E(a,HTMLTextAreaElement)&&(c.textContent=a.value),E(a,HTMLInputElement)&&c.setAttribute("value",a.value),fa(a,c));return c}).then(c=>ha(c,b)):null})};const Q=/url\((['"]?)([^'"]+?)\1\)/g,ia=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ja=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ka(a){const b=[];a.replace(Q,(d,c,e)=>{b.push(e);return d});return b.filter(d=>!H(d))}
function la(a,b,d,c){return t(function*(){try{const e=d?(new URL(b,d||void 0)).toString():b;let f;f=yield L(e,M[N(b).toLowerCase()]||"",c);return a.replace(new RegExp(`(url\\(['"]?)(${b.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")})(['"]?\\))`,"g"),`$1${f}$3`)}catch(e){}return a})}function ma(a,{I:b}){return b?a.replace(ja,d=>{for(;;){const [c,,e]=ia.exec(d)||[],f=c,g=e;if(!g)return"";if(g===b)return`src: ${f};`}}):a}
function R(a,b,d){return t(function*(){if(a.search(Q)===-1)return a;const c=ma(a,d);return ka(c).reduce((e,f)=>e.then(g=>la(g,f,b,d)),Promise.resolve(c))})};function S(a,b,d){return t(function*(){var c;const e=(c=b.style)==null?void 0:c.getPropertyValue(a);return e?(c=yield R(e,null,d),b.style.setProperty(a,c,b.style.getPropertyPriority(a)),!0):!1})}function na(a,b){return t(function*(){(yield S("background",a,b))||(yield S("background-image",a,b));(yield S("mask",a,b))||(yield S("-webkit-mask",a,b))||(yield S("mask-image",a,b))||(yield S("-webkit-mask-image",a,b))})}
function oa(a,b){return t(function*(){const d=E(a,HTMLImageElement);if(d&&!H(a.src)||E(a,SVGImageElement)&&!H(a.href.baseVal)){var c=d?a.src:a.href.baseVal,e=yield L(c,M[N(c).toLowerCase()]||"",b);yield new Promise((f,g)=>{a.onload=f;a.onerror=b.m?(...k)=>{try{f(b.m(...k))}catch(m){g(m)}}:g;a.decode&&(a.decode=f);a.loading==="lazy"&&(a.loading="eager");d?(a.srcset="",a.src=e):a.href.baseVal=e})}})}
function pa(a,b){return t(function*(){const d=w(a.childNodes).map(c=>T(c,b));yield Promise.all(d).then(()=>a)})}function T(a,b){return t(function*(){E(a,Element)&&(yield na(a,b),yield oa(a,b),yield pa(a,b))})};const U={};function V(a){return t(function*(){var b=U[a];if(b!=null)return b;b=yield(yield fetch(a)).text();b={url:a,cssText:b};return U[a]=b})}function W(a,b){return t(function*(){let d=a.cssText;const c=/url\(["']?([^"')]+)["']?\)/g,e=(d.match(/url\([^)]+\)/g)||[]).map(f=>t(function*(){let g=f.replace(c,"$1");g.startsWith("https://")||(g=(new URL(g,a.url)).href);return I(g,b.i,({result:k})=>{d=d.replace(f,`url(${k})`);return[f,k]})}));return Promise.all(e).then(()=>d)})}
function X(a){if(a==null)return[];const b=[];a=a.replace(/(\/\*[\s\S]*?\*\/)/gi,"");for(var d=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");;){var c=d.exec(a);if(c===null)break;b.push(c[0])}a=a.replace(d,"");d=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi;for(c=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");;){let e=d.exec(a);if(e===null)if(e=c.exec(a),e===null)break;else d.lastIndex=c.lastIndex;else c.lastIndex=
d.lastIndex;b.push(e[0])}return b}
function qa(a,b){return t(function*(){const d=[],c=[];a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach((f,g)=>{if(f.type===CSSRule.IMPORT_RULE){let k=g+1;f=V(f.href).then(m=>W(m,b)).then(m=>X(m).forEach(q=>{try{e.insertRule(q,q.startsWith("@import")?k+=1:e.cssRules.length)}catch(Da){}})).catch(()=>{});c.push(f)}})}catch(f){const g=a.find(k=>k.href==null)||document.styleSheets[0];e.href!=null&&c.push(V(e.href).then(k=>W(k,b)).then(k=>X(k).forEach(m=>{g.insertRule(m,g.cssRules.length)})).catch(()=>
{}))}});return Promise.all(c).then(()=>{a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach(f=>{d.push(f)})}catch(f){}});return d})})}function ra(a){return a.filter(b=>b.type===CSSRule.FONT_FACE_RULE).filter(b=>b.style.getPropertyValue("src").search(Q)!==-1)}function sa(a,b){return t(function*(){if(a.ownerDocument==null)throw Error("Provided element is not within a Document");var d=w(a.ownerDocument.styleSheets);d=yield qa(d,b);return ra(d)})}
function ta(a){function b(c){(c.style.fontFamily||getComputedStyle(c).fontFamily).split(",").forEach(e=>{d.add(e.trim().replace(/["']/g,""))});Array.from(c.children).forEach(e=>{e instanceof HTMLElement&&b(e)})}const d=new Set;b(a);return d}function ua(a,b){return t(function*(){const d=yield sa(a,b),c=ta(a);return(yield Promise.all(d.filter(e=>c.has(e.style.fontFamily.trim().replace(/["']/g,""))).map(e=>R(e.cssText,e.parentStyleSheet?e.parentStyleSheet.href:null,b)))).join("\n")})}
function va(a,b){return t(function*(){const d=b.j!=null?b.j:b.K?null:yield ua(a,b);if(d){const c=document.createElement("style");c.appendChild(document.createTextNode(d));a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)}})};function wa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b),e=yield P(a,b,!0);yield va(e,b);yield T(e,b);u(e,b);return yield D(e,d,c)})}
function xa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b);var e=yield wa(a,b);e=yield B(e);const f=document.createElement("canvas"),g=f.getContext("2d"),k=b.G||window.devicePixelRatio||1,m=b.h||d,q=b.g||c;f.width=m*k;f.height=q*k;!b.J&&(f.width>16384||f.height>16384)&&(f.width>16384&&f.height>16384?f.width>f.height?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=16384):f.width>16384?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=
16384));f.style.width=`${m}`;f.style.height=`${q}`;b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,f.width,f.height));g.drawImage(e,0,0,f.width,f.height);return f})}function ya(a,b={}){return t(function*(){return(yield xa(a,b)).toDataURL()})};const za=["gemini.google.com","corp.google.com","proxy.googlers.com"];function Y(){return document.body.querySelectorAll('[class*="animate"]').length>0}function Z(a){return t(function*(){try{return yield ya(a,{h:a.offsetWidth,g:a.offsetHeight})}catch(d){var b=a.offsetHeight;const c=document.createElement("canvas");c.width=a.offsetWidth;c.height=b;return c.toDataURL("image/png")}})}
function Aa(){return t(function*(){const a=document.body.offsetWidth,b=document.body.offsetHeight,d=document.body.cloneNode(!0);d.querySelectorAll('[class*="animate"]').forEach(c=>{c.classList.remove(...Array.from(c.classList).filter(e=>e.startsWith("animate")))});d.style.width=`${a}px`;d.style.height=`${b}px`;return d})}
function Ba(a){return t(function*(){let b=document.body;if(Y()){var d=yield Aa();b=d;document.body.appendChild(d)}d=yield Z(b);Y()&&document.body.removeChild(b);window.parent.postMessage({type:"SEND_SCREENSHOT",image:d,topOffset:document.documentElement.scrollTop},a.origin)})}function Ca(a){return t(function*(){const b={type:"SEND_SCREENSHOT_FOR_DATA_VISUALIZATION",image:yield Z(document.body),topOffset:0};window.parent.postMessage(b,a.origin)})}
window.addEventListener("message",a=>t(function*(){if(za.some(d=>a.origin.includes(d))){var b=a.data;b&&(b.type==="MAKE_SCREENSHOT"&&(yield Ba(a)),b.type==="MAKE_SCREENSHOT_FOR_DATA_VISUALIZATION"&&(yield Ca(a)))}}));
})();</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageTransformModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });
  modelInformation.deprecatedImageModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predict',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predictLongRunning',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash","imageModelName":"imagen-4.0-generate-001","imageEditModelName":"gemini-2.5-flash-image-preview","imageTransformModelName":"gemini-3-pro-image-preview-11-2025","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20","gemini-2.5-flash-preview-09-2025"],"deprecatedImageModelNames":["imagen-3.0-generate-001","imagen-3.0-generate-002"]})</script><script>(function(){'use strict';function a(){window.parent.postMessage({type:"interaction"},"*")}window.addEventListener("click",a,{capture:!0,passive:!0});window.addEventListener("touchstart",a,{capture:!0,passive:!0});window.addEventListener("keydown",a,{capture:!0,passive:!0});}).call(this);
</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cozy Grading Nook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Handwriting Fonts (Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&amp;family=Indie+Flower&amp;family=Gochi+Hand&amp;family=Kalam:wght@300;400;700&amp;family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet">
    <style>
        /* Pastel Colors & Fonts */
        :root {
            --pastel-blue: #B3E5FC; /* Light Blue (Sky) */
            --pastel-pink: #F8BBD0; /* Soft Pink (Rosy) */
            --pastel-mint: #C8E6C9; /* Mint Green (Fresh) */
            --pastel-yellow: #FFF9C4; /* Light Yellow (Paper) */
            --pastel-lavender: #E1BEE7; /* Lavender (Calm) */
            --pastel-peach: #FFCCBC; /* Peach (Warmth) */
            --pastel-teal: #B2DFDB; /* Teal (Accent) */
            --dark-text: #374151; /* Gray-700 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--pastel-blue);
            color: var(--dark-text);
            transition: background-color 0.5s ease;
            min-height: 100vh;
        }
        .app-container {
            max-width: 90%;
            margin: 0 auto;
            padding: 1.5rem 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .app-container {
                max-width: 950px;
                padding: 3rem 1rem;
            }
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .worksheet-content {
            background-color: var(--pastel-yellow);
            border: 2px dashed #9ca3af;
            padding: 1rem;
            border-radius: 1rem;
            min-height: 250px;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        /* Professional Question Font */
        .question-font {
            font-family: 'Times New Roman', Times, serif;
            font-style: italic;
            font-size: 0.95rem;
            color: #6B7280; /* Gray-500 for a printed look */
        }

        /* Handwriting Styles (for Student Answers) */
        .handwriting-neat { font-family: 'Caveat', cursive; font-size: 1.3rem; }
        .handwriting-blocky { font-family: 'Indie Flower', cursive; font-size: 1.15rem; }
        .handwriting-messy { font-family: 'Gochi Hand', cursive; font-size: 1.25rem; }
        .handwriting-bubbly { font-family: 'Kalam', cursive; font-size: 1.2rem; font-weight: 700; }
        .handwriting-simple { font-family: 'Inter', sans-serif; font-size: 1rem; }

        .grade-button {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .grade-button:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); }
        .A-grade { background-color: #81C784; }
        .B-grade { background-color: #FFEE58; }
        .C-grade { background-color: #FFB74D; }
        .D-grade { background-color: #EF5350; }
        .F-grade { background-color: #BDBDBD; }

        #history-list::-webkit-scrollbar { width: 8px; }
        #history-list::-webkit-scrollbar-thumb { background-color: var(--pastel-lavender); border-radius: 4px; }
        #history-list::-webkit-scrollbar-track { background: var(--pastel-blue); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 400px;
            text-align: center;
            position: relative;
        }
        .modal-show {
            display: flex;
        }
    </style>
    <!-- Font Awesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" crossorigin="anonymous"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // Grade Cache: { studentName: { subject: [{ scoreValue, type, scoreLetter, timestamp }] } }
        let gradesCache = {};

        // Game State Variables
        const students = [
            { name: 'Luna', style: 'handwriting-neat' },
            { name: 'Finn', style: 'handwriting-blocky' },
            { name: 'Maya', style: 'handwriting-bubbly' },
            { name: 'Caleb', style: 'handwriting-messy' },
            { name: 'Zoe', style: 'handwriting-neat' },
            { name: 'Noah', style: 'handwriting-blocky' },
            { name: 'Mia', style: 'handwriting-bubbly' },
            { name: 'Leo', style: 'handwriting-messy' },
            { name: 'Anya', style: 'handwriting-simple' },
            { name: 'Sam', style: 'handwriting-simple' },
            { name: 'Kai', style: 'handwriting-neat' },
            { name: 'Ella', style: 'handwriting-messy' },
        ];
        let subjects = ['Math', 'History', 'Science', 'Art', 'English'];
        let currentStudentIndex = 0; // Tracks total papers graded
        let currentSubject = 'Math'; // For Papers, this is the selected subject. For Tests, it's random.
        let currentPaperType = 'Paper';

        const gradeOptions = [
            { label: 'A+', color: 'A-grade' },
            { label: 'A', color: 'A-grade' },
            { label: 'B', color: 'B-grade' },
            { label: 'C', color: 'C-grade' },
            { label: 'D', color: 'D-grade' },
            { label: 'F', color: 'F-grade' },
        ];

        // --- Firebase Initialization and Authentication ---

        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                document.getElementById('loading-state').innerHTML = '<p class="text-red-600">Error: Database config not found. Grades cannot be saved.</p>';
                isAuthReady = true;
                setupGame();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `Teacher ID: ${userId}`;
                        isAuthReady = true;
                        console.log("Authentication successful. User ID:", userId);
                        setupGame();
                        setupGradeListener();
                    } else {
                        console.log("No user signed in. Attempting sign-in...");
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-600">Auth failed: ${error.message}</p>`;
                isAuthReady = true;
                setupGame();
            }
        };

        // --- Worksheet Data (The Key) ---

        const getRandomSubject = () => subjects[Math.floor(Math.random() * subjects.length)];

        const getWorksheetData = (subject, type) => {
            const student = getCurrentStudent().name;
            const isTest = type === 'Test';
            const numQuestions = isTest ? 8 : 4;

            const data = {
                student: student,
                type: type,
                subject: subject,
                questions: [],
                rubric: {},
                total_questions: numQuestions
            };

            switch (subject) {
                case 'Math':
                    data.questions = [
                        { text: "What is $12 + 7$?", answer: "19" },
                        { text: "If you have 5 apples and give 3 away, how many are left?", answer: "2" },
                        { text: "Calculate: $3 \\times 4 + 1$", answer: "13" },
                        { text: "Bonus: What is the area of a square with side length 5?", answer: "25" }
                    ];
                    if (isTest) {
                        data.questions.push(
                            { text: "Solve for x: $2x - 5 = 15$", answer: "10" },
                            { text: "What is $80 \\div 10 + 2$?", answer: "10" },
                            { text: "How many sides does a hexagon have?", answer: "6" },
                            { text: "What is $\\sqrt{16}$?", answer: "4" }
                        );
                    }
                    data.rubric = { 'A (90-100)': 'Excellent grasp of concepts.', 'B (80-89)': 'Good, minor errors.', 'C (70-79)': 'Basic understanding, needs practice.', 'D (60-69)': 'Needs significant review.', 'F (0-59)': 'Requires focused intervention.' };
                    break;

                case 'History':
                    data.questions = [
                        { text: "Who was the first President of the United States?", answer: "George Washington" },
                        { text: "In what year did the Titanic sink?", answer: "1912" },
                        { text: "What ancient civilization built the Great Pyramid of Giza?", answer: "Egyptians" },
                        { text: "Which country gifted the Statue of Liberty to the US?", answer: "France" }
                    ];
                    if (isTest) {
                        data.questions.push(
                            { text: "Who invented the light bulb?", answer: "Thomas Edison" },
                            { text: "What war occurred between 1861 and 1865 in the US?", answer: "Civil War" },
                            { text: "What country was invaded to start WWII?", answer: "Poland" },
                            { text: "What is the study of past events called?", answer: "History" }
                        );
                    }
                    data.rubric = { 'A (90-100)': 'Excellent grasp of concepts.', 'B (80-89)': 'Good, minor errors.', 'C (70-79)': 'Basic understanding, needs practice.', 'D (60-69)': 'Needs significant review.', 'F (0-59)': 'Requires focused intervention.' };
                    break;

                case 'Science':
                    data.questions = [
                        { text: "What is the chemical symbol for water?", answer: "H\\textsubscript{2}O" },
                        { text: "Name the planet closest to the Sun.", answer: "Mercury" },
                        { text: "What gas do plants absorb from the atmosphere?", answer: "Carbon Dioxide (CO\\textsubscript{2})" },
                        { text: "What is the process of water changing to ice called?", answer: "Freezing" }
                    ];
                    if (isTest) {
                        data.questions.push(
                            { text: "What is the main component of the air we breathe?", answer: "Nitrogen" },
                            { text: "What animal group includes crocodiles and snakes?", answer: "Reptiles" },
                            { text: "What part of the plant conducts photosynthesis?", answer: "Leaves" },
                            { text: "What is the unit of force in the metric system?", answer: "Newton" }
                        );
                    }
                    data.rubric = { 'A (90-100)': 'Excellent grasp of concepts.', 'B (80-89)': 'Good, minor errors.', 'C (70-79)': 'Basic understanding, needs practice.', 'D (60-69)': 'Needs significant review.', 'F (0-59)': 'Requires focused intervention.' };
                    break;

                case 'Art':
                    // Art is checklist based, so 8 questions is a bit much. Keeping it at 4 even for the "test" equivalent for simplicity, but making the stakes higher.
                    data.questions = [
                        { text: "Did the student use all colors provided?", answer: "Yes / Full Palette" },
                        { text: "Is the project fully completed?", answer: "Yes / Completed" },
                        { text: "Did they show creativity in use of space?", answer: "Yes / High Creativity" },
                        { text: "Did they follow the theme prompt?", answer: "Yes / Followed Prompt" }
                    ];
                    if (isTest) {
                        data.questions = [
                            { text: "Is the project neat and free of smudges?", answer: "Yes / Neat" },
                            ...data.questions, // 4 questions
                            { text: "Did they use appropriate media (e.g., only paint, no pencil)?", answer: "Yes / Appropriate Media" },
                            { text: "Did they sign their name?", answer: "Yes / Signed" },
                            { text: "Is the composition visually balanced?", answer: "Yes / Balanced" }
                        ];
                        data.total_questions = 8;
                    }

                    data.rubric = { 'A (90-100)': 'A true masterpiece. All criteria met.', 'B (80-89)': 'Excellent. All criteria met, minor detail missing.', 'C (70-79)': 'Good effort. Missing 2-3 key criteria.', 'D (60-69)': 'Needs much more detail/effort.', 'F (0-59)': 'Not submitted or basic criteria missing.' };
                    break;

                case 'English':
                    data.questions = [
                        { text: "What type of noun names a specific person or place?", answer: "Proper Noun" },
                        { text: "What is the past tense of the verb 'to run'?", answer: "Ran" },
                        { text: "Identify the conjunction in this sentence: 'I like dogs and cats.'", answer: "And" },
                        { text: "Write a synonym for 'happy'.", answer: "Joyful / Cheerful" }
                    ];
                    if (isTest) {
                        data.questions.push(
                            { text: "What punctuation is used to join two independent clauses?", answer: "Semicolon (;)" },
                            { text: "Which word is an adjective: 'quickly', 'beautiful', or 'run'?", answer: "Beautiful" },
                            { text: "What literary device is used in 'The silence was deafening'?", answer: "Oxymoron" },
                            { text: "Correct the error: 'He go to the store.'", answer: "He goes to the store." }
                        );
                    }
                    data.rubric = { 'A (90-100)': 'Excellent grasp of concepts.', 'B (80-89)': 'Good, minor errors.', 'C (70-79)': 'Basic understanding, needs practice.', 'D (60-69)': 'Needs significant review.', 'F (0-59)': 'Requires focused intervention.' };
                    break;
            }
            return data;
        };


        // --- Student Answer Generation & Grading Logic ---

        const generateStudentAnswer = (question, index, studentName) => {
            const studentIndex = students.findIndex(s => s.name === studentName);
            const studentMod = studentIndex % 8;
            const correct = question.answer;

            // Simple pseudo-randomness based on student's position in the list and question number
            const seed = (studentMod + index) * 7;
            const randomizer = Math.floor(Math.random() * 10) + seed;

            // Higher chance to get it right for "good" students
            if (studentMod <= 3 && randomizer % 3 !== 0) return correct;
            if (studentMod > 3 && randomizer % 5 === 0) return correct;

            // Generate plausible wrong/silly answers
            switch (currentSubject) {
                case 'Math':
                    if (index === 0) return randomizer % 2 === 0 ? "20" : "18";
                    if (index === 1) return randomizer % 2 === 0 ? "8 (I bought more!)" : "1";
                    if (index === 2) return randomizer % 2 === 0 ? "16 (Forgot the plus one)" : "15";
                    if (index === 3) return "24 (Close!)";
                    if (index === 4) return "x = 10.5 (Too much coffee)";
                    if (index === 5) return "9";
                    if (index === 6) return "5 (Forgot the 'h')";
                    if (index === 7) return "8 (Too big)";
                    return "Need to review basic arithmetic.";

                case 'History':
                    if (index === 0) return randomizer % 2 === 0 ? "Thomas Jefferson" : "Abraham Lincoln";
                    if (index === 1) return "1911 (A year too early)";
                    if (index === 2) return randomizer % 2 === 0 ? "The Mayans" : "The Romans";
                    if (index === 3) return "England (They were friends, right?)";
                    if (index === 4) return "Nikola Tesla";
                    if (index === 5) return "Revolutionary War";
                    if (index === 6) return "France";
                    if (index === 7) return "Archaeology";
                    return "I don't remember any of this.";

                case 'Science':
                    if (index === 0) return randomizer % 2 === 0 ? "HO" : "WTR";
                    if (index === 1) return "Venus (The hot one)";
                    if (index === 2) return randomizer % 2 === 0 ? "Oxygen" : "Nitrogen";
                    if (index === 3) return "Melting (Wait, opposite!)";
                    if (index === 4) return "Oxygen";
                    if (index === 5) return "Mammals";
                    if (index === 6) return "Roots";
                    if (index === 7) return "Kilogram (Weight is force, right?)";
                    return "Space is cool, though.";

                case 'Art':
                    // Art answers are mostly Yes/No. Failure is based on studentMod
                    if (index === 0) return studentMod % 3 === 0 ? "No (Only two colors)" : "Yes (Very colorful)";
                    if (index === 1) return studentMod % 2 === 0 ? "No (Missing background)" : "Yes (Looks done to me)";
                    if (index === 2) return studentMod % 4 === 0 ? "Low (It's just a stick figure)" : "High (Very creative use of glitter)";
                    if (index === 3) return studentMod % 5 === 0 ? "No (Used a thumbprint instead)" : "Yes (Signed clearly)";
                    if (index === 4) return studentMod % 3 === 0 ? "Yes, but smeared" : "No (Smudges)";
                    if (index === 5) return studentMod % 2 === 0 ? "No (Pencil sketch only)" : "Yes (Paint only)";
                    if (index === 6) return studentMod % 5 === 0 ? "No (Forgot to sign)" : "Yes (Signed clearly)";
                    if (index === 7) return studentMod % 4 === 0 ? "No (All heavy on one side)" : "Yes (Balanced)";
                    return "I tried my best!";

                case 'English':
                    if (index === 0) return randomizer % 2 === 0 ? "Common Noun" : "Verb";
                    if (index === 1) return "Runned";
                    if (index === 2) return "Dogs";
                    if (index === 3) return randomizer % 2 === 0 ? "Good" : "Smile";
                    if (index === 4) return "Comma (,)";
                    if (index === 5) return "Quickly (It sounds nice)";
                    if (index === 6) return "Simile";
                    if (index === 7) return "He went to the store."; // Close, but still technically wrong tense for the prompt
                    return "I love reading!";
            }
            return "Answer missing.";
        };

        const calculateScoreAndLetter = (worksheetData, studentName) => {
            const totalQuestions = worksheetData.total_questions;
            let correctCount = 0;

            worksheetData.questions.forEach((q, index) => {
                const studentAnswer = generateStudentAnswer(q, index, studentName);
                // Simple check: if the generated answer is the correct answer
                if (studentAnswer.toLowerCase().includes(q.answer.toLowerCase().split('(')[0].trim())) {
                    correctCount++;
                }
            });

            // Calculate score (0-100)
            const scoreValue = Math.round((correctCount / totalQuestions) * 100);

            let scoreLetter;
            // START OF MODIFICATION: Reverting to standard A-F scale (A for 90-100)
            if (scoreValue >= 90) scoreLetter = 'A';
            else if (scoreValue >= 80) scoreLetter = 'B';
            else if (scoreValue >= 70) scoreLetter = 'C';
            else if (scoreValue >= 60) scoreLetter = 'D';
            else scoreLetter = 'F';
            // END OF MODIFICATION

            return { scoreValue, scoreLetter, correctCount };
        };


        // --- Firestore Operations ---

        const getGradeCollectionRef = () => {
            if (!db || !userId) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/grades`);
        };

        const saveGrade = async (gradeData) => {
            if (!isAuthReady || !db) {
                console.error("Database not ready. Cannot save grade.");
                return;
            }
            try {
                const ref = getGradeCollectionRef();
                if (!ref) {
                    console.error("Collection reference is null.");
                    return;
                }
                const newGrade = {
                    studentName: gradeData.studentName,
                    subject: gradeData.subject,
                    scoreLetter: gradeData.scoreLetter,
                    scoreValue: gradeData.scoreValue, // New: Numeric score
                    type: gradeData.type, // New: Paper or Test
                    timestamp: serverTimestamp()
                };
                await addDoc(ref, newGrade);
                console.log("Grade saved successfully:", newGrade);
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        };

        const setupGradeListener = () => {
            if (!isAuthReady || !db) return;
            const ref = getGradeCollectionRef();
            if (!ref) return;

            const q = query(ref, orderBy("timestamp", "desc"));

            onSnapshot(q, (snapshot) => {
                // Clear and rebuild cache
                gradesCache = {};
                const historyList = document.getElementById('history-list');
                if (!historyList) return;

                if (snapshot.empty) {
                    historyList.innerHTML = '<p class="text-gray-500 p-4 text-center">Start grading to see history!</p>';
                    return;
                }

                let historyHtml = '';
                let index = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : 'N/A';
                    let scoreColor = 'text-gray-700';
                    if (data.scoreLetter.startsWith('A')) scoreColor = 'text-green-600 font-bold';
                    else if (data.scoreLetter.startsWith('B')) scoreColor = 'text-yellow-600 font-bold';
                    else if (data.scoreLetter.startsWith('C')) scoreColor = 'text-orange-600 font-bold';
                    else if (data.scoreLetter.startsWith('D') || data.scoreLetter.startsWith('F')) scoreColor = 'text-red-600 font-bold';

                    // Update Cache
                    if (!gradesCache[data.studentName]) {
                        gradesCache[data.studentName] = {};
                    }
                    if (!gradesCache[data.studentName][data.subject]) {
                        gradesCache[data.studentName][data.subject] = [];
                    }
                    // Only push essential calculation data to cache
                    gradesCache[data.studentName][data.subject].push({
                        scoreValue: data.scoreValue,
                        type: data.type,
                        scoreLetter: data.scoreLetter,
                        timestamp: data.timestamp
                    });

                    // Render History
                    if (index < 10) { // Only show last 10 for performance and space
                        historyHtml += `
                            <li class="p-3 border-b border-gray-100 flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-800 w-1/4 truncate">${data.studentName}</span>
                                <span class="text-gray-500 w-1/4 text-center">${data.subject} (${data.type})</span>
                                <span class="${scoreColor} text-lg w-1/4 text-center">${data.scoreLetter} (${data.scoreValue}%)</span>
                                <span class="text-xs text-gray-400 w-1/4 text-right">${timestamp}</span>
                            </li>
                        `;
                    }
                    index++;
                });
                historyList.innerHTML = `<ul class="space-y-1">${historyHtml}</ul>`;

                // Update total papers graded count from snapshot size
                currentStudentIndex = snapshot.size;
                document.getElementById('graded-count').textContent = currentStudentIndex;
                renderWorksheet(); // Rerender to show correct next paper type if needed

            }, (error) => {
                console.error("Error listening to grades:", error);
                document.getElementById('history-list').innerHTML = '<p class="text-red-600 p-4 text-center">Error loading history.</p>';
            });
        };

        // --- Report Card Logic ---

        const calculateAverageGrade = (studentName) => {
            const studentGrades = gradesCache[studentName];
            if (!studentGrades) return null;

            let totalScore = 0;
            let totalCount = 0;
            let subjectAverages = {};

            for (const subject in studentGrades) {
                let subjectSum = 0;
                let subjectCount = 0;
                studentGrades[subject].forEach(grade => {
                    subjectSum += grade.scoreValue;
                    subjectCount++;
                });

                if (subjectCount > 0) {
                    const avg = Math.round(subjectSum / subjectCount);
                    subjectAverages[subject] = avg;
                    totalScore += avg;
                    totalCount++;
                }
            }

            const overallAverage = totalCount > 0 ? Math.round(totalScore / totalCount) : 0;
            const { scoreLetter } = getLetterFromValue(overallAverage);

            return { overallAverage, scoreLetter, subjectAverages };
        };

        const getLetterFromValue = (scoreValue) => {
            let scoreLetter;
            // START OF MODIFICATION: Standard A-F scale
            if (scoreValue >= 90) scoreLetter = 'A';
            else if (scoreValue >= 80) scoreLetter = 'B';
            else if (scoreValue >= 70) scoreLetter = 'C';
            else if (scoreValue >= 60) scoreLetter = 'D';
            else scoreLetter = 'F';
            // END OF MODIFICATION
            return { scoreLetter };
        };

        const renderReportCard = (studentName) => {
            const data = calculateAverageGrade(studentName);

            if (!data) return; // Should not happen if triggered correctly

            let subjectList = '';
            for (const subject in data.subjectAverages) {
                const avg = data.subjectAverages[subject];
                const { scoreLetter } = getLetterFromValue(avg);
                subjectList += `
                    <li class="flex justify-between items-center text-gray-700 border-b border-gray-200 py-1">
                        <span class="font-semibold">${subject}</span>
                        <span class="${scoreLetter.startsWith('A') ? 'text-green-600' : scoreLetter.startsWith('B') ? 'text-yellow-600' : 'text-red-600'} font-bold">${scoreLetter} (${avg}%)</span>
                    </li>
                `;
            }

            const modalContent = document.getElementById('report-card-content');
            modalContent.innerHTML = `
                <h3 class="text-3xl font-extrabold text-indigo-700 mb-4">Report Card</h3>
                <p class="text-xl font-bold mb-6">${studentName}</p>

                <div class="mb-6">
                    <p class="text-sm font-semibold text-gray-500">Subject Averages:</p>
                    <ul class="text-left w-3/4 mx-auto mt-2 space-y-1">
                        ${subjectList}
                    </ul>
                </div>

                <div class="p-4 rounded-xl shadow-inner mx-auto" style="background-color: var(--pastel-mint);">
                    <p class="text-base font-semibold text-gray-600">Overall Average:</p>
                    <p class="text-5xl font-black mt-1 ${data.scoreLetter.startsWith('A') ? 'text-green-700' : data.scoreLetter.startsWith('B') ? 'text-yellow-700' : 'text-red-700'}">
                        ${data.scoreLetter}
                    </p>
                    <p class="text-sm text-gray-500">(${data.overallAverage}%)</p>
                </div>
            `;
            document.getElementById('report-card-modal').classList.add('modal-show');
        };
        window.closeModal = () => document.getElementById('report-card-modal').classList.remove('modal-show');


        // --- Game Logic and UI Rendering ---

        const getCurrentStudent = () => students[currentStudentIndex % students.length];

        const renderWorksheetContent = (data) => {
            let html = `
                <h3 class="text-xl font-bold mb-2">${data.subject} ${data.type}</h3>
                <p>Student: ${data.student}</p>
                <hr class="my-2 border-gray-400">
                <p class="text-sm text-red-600 font-bold mb-2">Total Questions: ${data.total_questions}</p>
            `;
            const studentName = data.student;

            data.questions.forEach((q, index) => {
                const studentAnswer = generateStudentAnswer(q, index, studentName);
                html += `
                    <div class="mt-3">
                        <p>
                            <strong>Q${index + 1}:</strong>
                            <span class="question-font">${q.text}</span>
                        </p>
                        <p class="text-gray-600 pl-4">A: ${studentAnswer}</p>
                    </div>
                `;
            });

            html += `<p class="mt-4 text-sm text-right">-- Time to stamp my mark! --</p>`;
            return html;
        };

        const renderAnswerKey = (data) => {
            let keyHtml = `
                <h3 class="text-xl font-bold mb-4 text-purple-700 flex items-center">
                    <i class="fas fa-key mr-2"></i> Answer Key & Rubric
                </h3>
                <div class="space-y-4">
                    <div class="border-b pb-3">
                        <p class="font-semibold mb-2">Correct Answers (${data.total_questions} Questions):</p>
                        <ol class="list-decimal list-inside pl-4 space-y-1 text-sm">
                            ${data.questions.map((q, index) => `
                                <li><strong>Q${index + 1}:</strong> ${q.answer}</li>
                            `).join('')}
                        </ol>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">Grading Rubric (Based on 0-100 Score):</p>
                        <ul class="space-y-1 text-sm">
                            ${Object.entries(data.rubric).map(([grade, condition]) => `
                                <li class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                    <span class="font-bold text-lg">${grade}</span>
                                    <span class="text-gray-600">${condition}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('answer-key-content').innerHTML = keyHtml;
        };

        const toggleAnswerKey = () => {
            const keyCard = document.getElementById('answer-key-card');
            const keyButton = document.getElementById('toggle-key-button');
            if (keyCard.classList.contains('hidden')) {
                keyCard.classList.remove('hidden');
                keyButton.textContent = 'Hide Answer Key';
            } else {
                keyCard.classList.add('hidden');
                keyButton.textContent = 'Show Answer Key';
            }
        };
        window.toggleAnswerKey = toggleAnswerKey;


        const renderWorksheet = () => {
            // Determine if it's a Test or a regular Paper
            const nextPaperCount = currentStudentIndex + 1;
            const isTest = nextPaperCount > 0 && nextPaperCount % 5 === 0;
            currentPaperType = isTest ? 'Test' : 'Paper';

            // For tests, randomly select the subject. For papers, use the selected subject.
            const subjectForPaper = isTest ? getRandomSubject() : currentSubject;
            
            // Only update currentSubject if it's a test so the user selected subject remains for the next paper
            if (isTest) {
                document.getElementById('subject-select').value = subjectForPaper;
            }

            const studentData = getCurrentStudent();
            const worksheetData = getWorksheetData(subjectForPaper, currentPaperType);
            
            // Store the data so handleGrade can access it
            window.currentWorksheetData = worksheetData;

            document.getElementById('worksheet-title').textContent = `${worksheetData.subject} ${worksheetData.type}`;
            const worksheetEl = document.getElementById('worksheet-content');
            worksheetEl.innerHTML = renderWorksheetContent(worksheetData);
            document.getElementById('current-student').textContent = studentData.name;
            renderAnswerKey(worksheetData);

            // Set unique handwriting style (for student answers)
            worksheetEl.className = 'worksheet-content text-base'; // Reset classes
            worksheetEl.classList.add(studentData.style); // Add student's unique style
            document.getElementById('paper-type-display').textContent = currentPaperType;


            // Update body background color based on subject (using a wider palette)
            let colorVar;
            switch(worksheetData.subject) {
                case 'Math': colorVar = 'var(--pastel-pink)'; break;
                case 'History': colorVar = 'var(--pastel-mint)'; break;
                case 'Science': colorVar = 'var(--pastel-lavender)'; break;
                case 'Art': colorVar = 'var(--pastel-peach)'; break;
                case 'English': colorVar = 'var(--pastel-teal)'; break;
                default: colorVar = 'var(--pastel-blue)'; break;
            }
            document.body.style.backgroundColor = colorVar;

            // Hide key on new paper for a clean start
            document.getElementById('answer-key-card').classList.add('hidden');
            document.getElementById('toggle-key-button').textContent = 'Show Answer Key';
        };

        const handleGrade = async (scoreLetter) => {
            const student = getCurrentStudent().name;
            const worksheetData = window.currentWorksheetData;

            // Calculate numeric score based on the simulated answers
            const { scoreValue } = calculateScoreAndLetter(worksheetData, student);
            
            // Report card check: Trigger after every 3 tests (i.e., after the 15th paper, 30th, etc.)
            const isReportCardTime = (currentStudentIndex + 1) > 0 && (currentStudentIndex + 1) % 15 === 0;

            const gradeData = {
                studentName: student,
                subject: worksheetData.subject,
                scoreLetter: scoreLetter,
                scoreValue: scoreValue,
                type: worksheetData.type,
            };

            await saveGrade(gradeData);

            const feedbackBox = document.getElementById('feedback-box');
            feedbackBox.innerHTML = `
                <div class="p-3 text-lg font-bold text-white rounded-xl shadow-lg transition-all duration-300"
                     style="background-color: ${scoreLetter.startsWith('A') ? '#4CAF50' : scoreLetter.startsWith('B') ? '#FFC107' : '#E57373'};">
                    <i class="fas fa-check-circle mr-2"></i> ${student} graded: ${scoreLetter} (${scoreValue}%)!
                </div>
            `;
            setTimeout(() => {
                feedbackBox.innerHTML = '';
            }, 2500);
            
            // Check for Report Card after saving the grade
            if (isReportCardTime) {
                // Ensure grade cache updates before showing report card
                setTimeout(() => renderReportCard(student), 500); 
            }

            // Note: currentStudentIndex is updated by the onSnapshot listener, which triggers renderWorksheet()
            // If the listener fails or is slow, this won't be perfectly smooth, but it relies on Firestore for truth.
        };

        const setupGame = () => {
            // Setup subject selection dropdown
            const subjectSelect = document.getElementById('subject-select');
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            subjectSelect.value = currentSubject;
            subjectSelect.onchange = (e) => {
                // Only allow subject change if the next paper is NOT a test
                if (currentPaperType !== 'Test') {
                    currentSubject = e.target.value;
                    renderWorksheet();
                } else {
                     // Optionally revert the selection if user tries to change during a Test queue
                     e.target.value = currentSubject;
                }
            };

            // Setup grade buttons
            const gradeButtonsContainer = document.getElementById('grade-buttons');
            gradeOptions.forEach(grade => {
                const button = document.createElement('button');
                button.textContent = grade.label;
                button.className = `grade-button ${grade.color} text-white font-bold py-3 px-5 rounded-xl text-lg hover:opacity-90 active:scale-95 w-full md:w-auto`;
                button.onclick = () => handleGrade(grade.label);
                gradeButtonsContainer.appendChild(button);
            });

            document.getElementById('loading-state').remove();
            document.getElementById('game-content').classList.remove('hidden');
            renderWorksheet();
        };

        window.onload = initializeFirebase;

    </script>
</head>
<body>

    <!-- Report Card Modal -->
    <div id="report-card-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times-circle text-2xl"></i>
            </button>
            <div id="report-card-content">
                <!-- Content will be rendered here -->
            </div>
            <button onclick="closeModal()" class="mt-6 w-full bg-indigo-500 text-white font-bold py-2 rounded-lg hover:bg-indigo-600 transition">
                Continue Grading
            </button>
        </div>
    </div>
    <!-- End Report Card Modal -->

    <div class="app-container">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800"> The Cozy Grading Nook </h1>
            <p class="text-gray-600 mt-1">Total Graded Papers: <span id="graded-count" class="font-semibold text-purple-600">0</span></p>
            <div id="user-id-display" class="text-xs text-gray-400 mt-2"></div>
        </header>

        <!-- Loading State (Replaced after Firebase Init) -->
        <div id="loading-state" class="card text-center p-8">
            <i class="fas fa-spinner fa-spin text-2xl text-purple-400"></i>
            <p class="mt-3 text-gray-700">Setting up the desk and collecting papers...</p>
        </div>

        <!-- Game Content (Hidden until loaded) -->
        <div id="game-content" class="hidden space-y-6">

            <!-- Subject Selection & Current Student -->
            <div class="card flex flex-col md:flex-row justify-between items-center bg-purple-50 p-4" style="background-color: var(--pastel-lavender);">
                <div class="flex items-center space-x-3 mb-3 md:mb-0">
                    <label for="subject-select" class="font-semibold text-lg text-gray-700">Subject:</label>
                    <select id="subject-select" class="p-2 border border-purple-300 rounded-lg shadow-inner bg-white cursor-pointer transition focus:ring-purple-400">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <h2 class="text-2xl font-extrabold text-purple-800">
                    <span id="paper-type-display" class="bg-yellow-300 p-1 rounded-md text-sm align-middle">Paper</span> for <span id="current-student" class="underline"></span>
                </h2>
            </div>

            <!-- Main Grading Area: Worksheet and Key Toggle -->
            <div class="md:grid md:grid-cols-2 md:gap-4 flex flex-col-reverse">
                <!-- Left: Worksheet Display -->
                <div class="card p-6 border-4 border-gray-300 border-dashed bg-white md:col-span-1 order-2 md:order-1">
                    <h3 id="worksheet-title" class="text-2xl font-bold mb-4 text-center">Worksheet Title</h3>
                    <div id="worksheet-content" class="worksheet-content text-base">
                        <!-- Worksheet content rendered by JS -->
                    </div>
                </div>

                <!-- Right: Key Button & Card (Collapsible) -->
                <div class="md:col-span-1 space-y-4 order-1 md:order-2">
                    <button id="toggle-key-button" onclick="toggleAnswerKey()" class="w-full bg-indigo-400 text-white font-bold py-3 rounded-xl shadow-md hover:bg-indigo-500 transition" style="background-color: var(--pastel-teal);">
                        Show Answer Key
                    </button>
                    <div id="answer-key-card" class="card p-4 hidden" style="background-color: var(--pastel-mint);">
                        <div id="answer-key-content">
                            <!-- Answer Key content rendered by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grading Controls -->
            <div class="card bg-pink-50 p-4" style="background-color: var(--pastel-pink);">
                <h3 class="text-xl font-semibold mb-3 text-center">Stamp the Letter Grade! (Score is calculated automatically)</h3>
                <div id="grade-buttons" class="flex flex-wrap justify-center gap-3">
                    <!-- Grade buttons rendered by JS -->
                </div>
                <div id="feedback-box" class="mt-4 h-8 flex justify-center items-center">
                    <!-- Grade feedback appears here -->
                </div>
            </div>

            <!-- Grading History -->
            <div class="card bg-teal-50 p-4" style="background-color: var(--pastel-peach);">
                <h3 class="text-xl font-semibold mb-3 flex items-center text-gray-800">
                    <i class="fas fa-scroll mr-2 text-teal-600"></i> Grading History (Recent 10)
                </h3>
                <div id="history-list" class="max-h-48 overflow-y-auto bg-white rounded-lg border border-teal-200">
                    <!-- History list filled by JS listener -->
                </div>
            </div>

        </div> <!-- End of game-content -->

    </div>


</body></html>